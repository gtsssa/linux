name: Linux Desktop
on: 
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Ubuntu Desktop with NoVNC
      run: |
        # 安装必要的依赖
        sudo apt-get update
        sudo apt-get install -y \
          xfce4 \
          xfce4-goodies \
          x11vnc \
          novnc \
          websockify \
          firefox \
          git \
          curl \
          wget \
          gnome-terminal \
          net-tools \
          dbus-x11
        
        # 创建VNC密码文件 - 使用x11vnc的非交互方法
        mkdir -p ~/.vnc
        # 创建一个脚本来自动回答y
        printf 'y\n' | x11vnc -storepasswd asdf1234 ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        # 配置XFCE桌面环境
        echo "export DISPLAY=:1" >> ~/.bashrc
        echo "export LANG=en_US.UTF-8" >> ~/.bashrc
        echo "export LANGUAGE=en_US:en" >> ~/.bashrc
        
        # 设置自动启动脚本
        cat > ~/start_desktop.sh << 'EOF'
        #!/bin/bash
        export DISPLAY=:1
        Xvfb :1 -screen 0 1280x720x24 &
        sleep 2
        startxfce4 &
        sleep 5
        x11vnc -display :1 -forever -shared -rfbport 5900 -passwdfile ~/.vnc/passwd &
        sleep 2
        websockify --web /usr/share/novnc/ 6080 localhost:5900 &
        EOF
        
        chmod +x ~/start_desktop.sh

    - name: Download and setup Cloudflared
      run: |
        # 下载cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Start NoVNC and Cloudflared
      run: |
        # 启动桌面环境
        bash ~/start_desktop.sh &
        
        # 等待服务启动
        sleep 15
        
        # 启动cloudflared隧道
        echo "正在启动cloudflared隧道..."
        cloudflared tunnel --url http://localhost:6080 2>&1 | tee cloudflared.log &
        
        # 等待隧道建立
        sleep 20
        
        # 从日志中提取访问URL
        if grep -q "trycloudflare.com" cloudflared.log; then
          TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' cloudflared.log | head -1)
          echo "访问地址: $TUNNEL_URL"
          echo "VNC密码: asdf1234"
          echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
        fi

    - name: Keep alive
      run: |
        echo "桌面运行中..."
        echo "URL: ${{ env.NOVNC_URL || '等待URL生成...' }}"
        echo "密码: asdf1234"
        
        # 保持工作流运行
        timeout 6h bash -c 'while true; do sleep 300; done'
