name: Linux Desktop Simple
on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install and start
      run: |
        # 安装
        sudo apt update
        sudo apt install -y xfce4 x11vnc novnc
        
        # 创建密码
        mkdir -p ~/.vnc
        echo -e "y\ny" | x11vnc -storepasswd asdf1234 ~/.vnc/passwd
        
        # 启动Xvfb
        Xvfb :99 -screen 0 1024x768x24 &
        export DISPLAY=:99
        sleep 3
        
        # 启动XFCE
        startxfce4 &
        sleep 5
        
        # 启动VNC
        x11vnc -display :99 -forever -shared -rfbport 5900 -passwdfile ~/.vnc/passwd -bg
        
        # 使用novnc自带的启动脚本
        /usr/share/novnc/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
        
        echo "服务已启动"
        sleep 10
        
    - name: Setup tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        ./cloudflared-linux-amd64 tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        sleep 35
        echo "查看日志获取URL: tail -f tunnel.log"
        
    - name: Run
      run: |
        echo "密码: asdf1234"
        timeout 355m tail -f tunnel.log
