name: Linux
on: 
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Ubuntu Desktop with NoVNC
      run: |
        # å®‰è£…å¿…è¦çš„ä¾èµ–ï¼ˆåŒ…å«vncpasswdï¼‰
        sudo apt-get update
        sudo apt-get install -y \
          xfce4 \
          xfce4-goodies \
          x11vnc \
          novnc \
          websockify \
          firefox \
          git \
          curl \
          wget \
          gnome-terminal \
          net-tools \
          dbus-x11 \
          tightvncserver  # è¿™ä¸ªåŒ…åŒ…å«vncpasswdå‘½ä»¤
        
        # æ–¹æ³•1ï¼šå°è¯•ä½¿ç”¨vncpasswdå‘½ä»¤
        echo "å°è¯•æ–¹æ³•1ï¼šä½¿ç”¨vncpasswd..."
        mkdir -p ~/.vnc
        if command -v vncpasswd &> /dev/null; then
          echo "ä½¿ç”¨vncpasswdå‘½ä»¤"
          echo "asdf1234" | vncpasswd -f > ~/.vnc/passwd
        else
          echo "vncpasswdå‘½ä»¤æœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ–¹æ³•2ï¼šPythonç”Ÿæˆå¯†ç "
          # æ–¹æ³•2ï¼šä½¿ç”¨Pythonç”Ÿæˆx11vncå¯†ç æ–‡ä»¶
          python3 << 'EOF'
import os
import struct

password = "asdf1234"
# x11vncå¯†ç æ ¼å¼ï¼šå¯†ç å­—èŠ‚+ç©ºå­—èŠ‚å¡«å……åˆ°8å­—èŠ‚
passwd_bytes = b''
for char in password:
    passwd_bytes += char.encode('utf-8')
    passwd_bytes += b'\x00'
# å¡«å……åˆ°8å­—èŠ‚
passwd_bytes = passwd_bytes.ljust(8, b'\x00')

with open(os.path.expanduser('~/.vnc/passwd'), 'wb') as f:
    f.write(passwd_bytes)
print("å¯†ç æ–‡ä»¶å·²åˆ›å»º")
EOF
        fi
        
        chmod 600 ~/.vnc/passwd
        
        # æ–¹æ³•3ï¼šå¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨x11vncçš„-storepasswdé€‰é¡¹
        echo "æ–¹æ³•3ï¼šä½¿ç”¨x11vnc-storepasswdåˆ›å»ºå¯†ç æ–‡ä»¶..."
        x11vnc -storepasswd asdf1234 ~/.vnc/passwd2 <<EOF
y
EOF
        if [ -f ~/.vnc/passwd2 ]; then
          mv ~/.vnc/passwd2 ~/.vnc/passwd
          echo "ä½¿ç”¨x11vnc-storepasswdåˆ›å»ºçš„å¯†ç æ–‡ä»¶"
        fi
        
        # éªŒè¯å¯†ç æ–‡ä»¶
        if [ -f ~/.vnc/passwd ]; then
          echo "å¯†ç æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼Œå¤§å°: $(wc -c < ~/.vnc/passwd) å­—èŠ‚"
        else
          echo "è­¦å‘Šï¼šæœªèƒ½åˆ›å»ºå¯†ç æ–‡ä»¶"
          # åˆ›å»ºç©ºå¯†ç æ–‡ä»¶ï¼ˆä¸å®‰å…¨ï¼Œä»…æµ‹è¯•ç”¨ï¼‰
          echo "åˆ›å»ºç©ºå¯†ç æ–‡ä»¶..."
          echo -n "" > ~/.vnc/passwd
        fi
        
        # é…ç½®XFCEæ¡Œé¢ç¯å¢ƒ
        echo "export DISPLAY=:1" >> ~/.bashrc
        echo "export LANG=en_US.UTF-8" >> ~/.bashrc
        echo "export LANGUAGE=en_US:en" >> ~/.bashrc
        
        # è®¾ç½®è‡ªåŠ¨å¯åŠ¨XFCEçš„è„šæœ¬ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        cat > ~/start_desktop.sh << 'EOF'
#!/bin/bash
# è®¾ç½®æ˜¾ç¤º
export DISPLAY=:1

# æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§è¿›ç¨‹
pkill -f "Xvfb :1" 2>/dev/null || true
pkill -f "xfce4" 2>/dev/null || true
pkill -f "x11vnc" 2>/dev/null || true
pkill -f "novnc" 2>/dev/null || true

# å¯åŠ¨è™šæ‹Ÿå¸§ç¼“å†²
echo "å¯åŠ¨Xvfb..."
Xvfb :1 -screen 0 1024x768x24 -ac +extension GLX +render -noreset > /dev/null 2>&1 &
XVFB_PID=$!
sleep 3

# å¯åŠ¨XFCEæ¡Œé¢
echo "å¯åŠ¨XFCE..."
startxfce4 > /dev/null 2>&1 &
XFCE_PID=$!
sleep 5

# å¯åŠ¨VNCæœåŠ¡å™¨
echo "å¯åŠ¨VNCæœåŠ¡å™¨..."
if [ -f ~/.vnc/passwd ]; then
    echo "ä½¿ç”¨å¯†ç æ–‡ä»¶"
    x11vnc -display :1 -forever -shared -rfbport 5900 -passwdfile ~/.vnc/passwd -bg -noxdamage
else
    echo "ä½¿ç”¨æ˜æ–‡å¯†ç "
    x11vnc -display :1 -forever -shared -rfbport 5900 -passwd asdf1234 -bg -noxdamage
fi
sleep 2

# å¯åŠ¨noVNC
echo "å¯åŠ¨noVNC..."
websockify --web /usr/share/novnc/ 6080 localhost:5900 > /dev/null 2>&1 &
NOVNC_PID=$!

echo "æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"
echo "VNCç«¯å£: 5900"
echo "noVNCç«¯å£: 6080"
echo "å¯†ç : asdf1234"

# ç­‰å¾…è¿›ç¨‹
wait $NOVNC_PID
EOF
        
        chmod +x ~/start_desktop.sh

    - name: Download and setup Cloudflared
      run: |
        # ä¸‹è½½cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        
        # æµ‹è¯•cloudflared
        cloudflared --version

    - name: Start NoVNC and Cloudflared
      run: |
        # å¯åŠ¨æ¡Œé¢ç¯å¢ƒ
        echo "å¯åŠ¨æ¡Œé¢ç¯å¢ƒ..."
        bash ~/start_desktop.sh > ~/desktop.log 2>&1 &
        DESKTOP_PID=$!
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        for i in {1..10}; do
          if netstat -tln 2>/dev/null | grep -q ":6080"; then
            echo "noVNCå·²å¯åŠ¨"
            break
          fi
          echo "ç­‰å¾…ä¸­... ($i/10)"
          sleep 3
        done
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
        echo "è¿›ç¨‹çŠ¶æ€:"
        ps aux | grep -E '(Xvfb|xfce4|x11vnc|websockify)' | grep -v grep || echo "æ— ç›¸å…³è¿›ç¨‹"
        echo ""
        echo "ç«¯å£ç›‘å¬:"
        netstat -tln 2>/dev/null | grep -E '(5900|6080)' || echo "ç«¯å£æœªç›‘å¬"
        echo ""
        echo "æ¡Œé¢æ—¥å¿—ç‰‡æ®µ:"
        tail -10 ~/desktop.log
        
        # å¯åŠ¨cloudflaredéš§é“
        echo "å¯åŠ¨cloudflaredéš§é“..."
        cloudflared tunnel --url http://localhost:6080 > ~/tunnel.log 2>&1 &
        TUNNEL_PID=$!
        
        # ç­‰å¾…éš§é“å»ºç«‹
        echo "ç­‰å¾…éš§é“å»ºç«‹..."
        sleep 20
        
        # ä»æ—¥å¿—ä¸­æå–è®¿é—®URL
        if grep -q "trycloudflare.com" ~/tunnel.log; then
          echo "éš§é“å·²å»ºç«‹ï¼"
          TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' ~/tunnel.log | head -1)
          echo "è®¿é—®åœ°å€: $TUNNEL_URL"
          echo "VNCå¯†ç : asdf1234"
          
          # å°†URLè®¾ç½®ä¸ºGitHub Actionsè¾“å‡º
          echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "::notice title=è®¿é—®ä¿¡æ¯::æ¡Œé¢å·²å¯åŠ¨ï¼è®¿é—®åœ°å€: $TUNNEL_URL VNCå¯†ç : asdf1234"
          
          # ä¿å­˜URLåˆ°æ–‡ä»¶
          echo "$TUNNEL_URL" > ~/tunnel_url.txt
        else
          echo "è­¦å‘Š: æ— æ³•ä»æ—¥å¿—ä¸­æå–éš§é“URL"
          echo "éš§é“æ—¥å¿—å†…å®¹:"
          tail -20 ~/tunnel.log
          
          # å°è¯•å…¶ä»–æ–¹å¼è·å–URL
          echo "å°è¯•å…¶ä»–æ–¹å¼è·å–URL..."
          sleep 10
          if grep -q "trycloudflare.com" ~/tunnel.log; then
            TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' ~/tunnel.log | head -1)
            echo "æ‰¾åˆ°URL: $TUNNEL_URL"
            echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
          fi
        fi

    - name: Keep alive with monitoring
      run: |
        echo "========================================"
        echo "Ubuntu Desktop ç¯å¢ƒä¿¡æ¯"
        echo "========================================"
        
        # æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
        if [ -f ~/tunnel_url.txt ]; then
          TUNNEL_URL=$(cat ~/tunnel_url.txt)
          echo "âœ… è®¿é—®åœ°å€: $TUNNEL_URL"
        elif [ -n "${{ env.NOVNC_URL }}" ]; then
          echo "âœ… è®¿é—®åœ°å€: ${{ env.NOVNC_URL }}"
        else
          echo "âš ï¸  éš§é“URLæœªæ‰¾åˆ°"
          echo "æœ¬åœ°è®¿é—®: http://localhost:6080"
        fi
        
        echo "ğŸ”‘ VNCå¯†ç : asdf1234"
        echo ""
        echo "ğŸ“Š ç›‘æ§ä¿¡æ¯:"
        
        # ç›‘æ§å¾ªç¯
        COUNTER=0
        while [ $COUNTER -lt 360 ]; do  # æœ€å¤š6å°æ—¶
          echo ""
          echo "[$(date '+%H:%M:%S')] è¿è¡ŒçŠ¶æ€:"
          
          # æ£€æŸ¥è¿›ç¨‹
          echo "è¿›ç¨‹çŠ¶æ€:"
          ps aux | grep -E '(Xvfb|xfce4|x11vnc|websockify|cloudflared)' | grep -v grep | head -5 || echo "  æ— "
          
          # æ£€æŸ¥ç«¯å£
          echo "ç«¯å£ç›‘å¬:"
          netstat -tln 2>/dev/null | grep -E '(5900|6080)' || echo "  æ— "
          
          # æ£€æŸ¥éš§é“æ—¥å¿—
          if [ -f ~/tunnel.log ] && tail -1 ~/tunnel.log | grep -q "trycloudflare.com"; then
            echo "éš§é“çŠ¶æ€: âœ… æ­£å¸¸"
          elif [ -f ~/tunnel.log ]; then
            echo "éš§é“çŠ¶æ€: âš ï¸  è¿è¡Œä¸­"
          else
            echo "éš§é“çŠ¶æ€: âŒ æœªè¿è¡Œ"
          fi
          
          let COUNTER=COUNTER+1
          sleep 60
        done
        
        echo "å·¥ä½œæ—¶é—´ç»“æŸï¼ˆ6å°æ—¶ï¼‰"

    - name: Cleanup
      if: always()
      run: |
        echo "æ¸…ç†è¿›ç¨‹..."
        pkill -f "Xvfb" 2>/dev/null || true
        pkill -f "xfce4" 2>/dev/null || true
        pkill -f "x11vnc" 2>/dev/null || true
        pkill -f "websockify" 2>/dev/null || true
        pkill -f "cloudflared" 2>/dev/null || true
        echo "æ¸…ç†å®Œæˆ"
