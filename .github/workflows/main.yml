name: CI
on: [push, workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Ubuntu Desktop with NoVNC
      run: |
        # å®‰è£…å¿…è¦çš„ä¾èµ–ï¼ˆåŒ…å«tightvncserverï¼‰
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          xfce4 \
          xfce4-goodies \
          x11vnc \
          novnc \
          websockify \
          firefox \
          git \
          curl \
          wget \
          gnome-terminal \
          net-tools \
          dbus-x11 \
          tightvncserver \
          xvfb \
          xserver-xorg-video-dummy \
          x11-xserver-utils \
          xfonts-base \
          xauth
        
        # åˆ›å»ºVNCå¯†ç æ–‡ä»¶ï¼ˆä½¿ç”¨æ›¿ä»£æ–¹æ³•ï¼‰
        mkdir -p ~/.vnc
        
        # æ–¹æ³•1ï¼šä½¿ç”¨Pythonç”Ÿæˆå¯†ç æ–‡ä»¶
        python3 -c "
import base64
import struct

password = 'asdf1234'
passwd = b''
for c in password:
    passwd += c.encode('utf-8')
    passwd += b'\x00\x00'
key = passwd.ljust(8, b'\x00')

with open('/home/runner/.vnc/passwd', 'wb') as f:
    f.write(key)
"
        
        # æˆ–è€…æ–¹æ³•2ï¼šä½¿ç”¨opensslï¼ˆæ›´ç®€å•ï¼‰
        echo -n "asdf1234" | openssl passwd -stdin > /tmp/passwd_tmp
        mv /tmp/passwd_tmp ~/.vnc/passwd
        
        chmod 600 ~/.vnc/passwd
        
        # é…ç½®çŽ¯å¢ƒå˜é‡
        echo "export DISPLAY=:1" >> ~/.bashrc
        echo "export LANG=en_US.UTF-8" >> ~/.bashrc
        echo "export LANGUAGE=en_US:en" >> ~/.bashrc
        source ~/.bashrc
        
        # è®¾ç½®è‡ªåŠ¨å¯åŠ¨è„šæœ¬ï¼ˆç®€åŒ–ç‰ˆï¼‰
        cat > ~/start_desktop.sh << 'EOF'
#!/bin/bash

# è®¾ç½®æ˜¾ç¤º
export DISPLAY=:1
export XAUTHORITY=$HOME/.Xauthority

# å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º
Xvfb :1 -screen 0 1280x720x24 -ac +extension GLX +render -noreset &
XVFB_PID=$!
sleep 3

# è®¾ç½®xauth
xauth add :1 . $(mcookie)

# å¯åŠ¨XFCEæ¡Œé¢
startxfce4 &
sleep 5

# å¯åŠ¨VNCæœåŠ¡å™¨ï¼ˆä½¿ç”¨x11vncï¼‰
x11vnc -display :1 -noxdamage -forever -shared -rfbport 5900 -passwd asdf1234 -bg
sleep 2

# å¯åŠ¨noVNC
/usr/share/novnc/utils/launch.sh --vnc localhost:5900 --listen 6080 --web /usr/share/novnc/ &
NOVNC_PID=$!

echo "æ¡Œé¢çŽ¯å¢ƒå·²å¯åŠ¨"
echo "VNCç«¯å£: 5900"
echo "noVNCç«¯å£: 6080"
echo "å¯†ç : asdf1234"

# ä¿æŒè„šæœ¬è¿è¡Œ
wait $NOVNC_PID
EOF
        
        chmod +x ~/start_desktop.sh

    - name: Download and setup Cloudflared
      run: |
        # ä¸‹è½½cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        
        # æµ‹è¯•cloudflared
        cloudflared --version

    - name: Start Desktop Environment
      run: |
        # å¯åŠ¨æ¡Œé¢çŽ¯å¢ƒï¼ˆåŽå°è¿è¡Œï¼‰
        bash ~/start_desktop.sh > ~/desktop.log 2>&1 &
        DESKTOP_PID=$!
        
        echo "ç­‰å¾…æ¡Œé¢çŽ¯å¢ƒå¯åŠ¨..."
        sleep 20
        
        # æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
        echo "æ£€æŸ¥è¿›ç¨‹:"
        ps aux | grep -E '(Xvfb|x11vnc|novnc)' | grep -v grep || echo "æœªæ‰¾åˆ°ç›¸å…³è¿›ç¨‹"
        
        echo "æ£€æŸ¥ç«¯å£:"
        netstat -tlnp | grep -E '(5900|6080)' || echo "ç«¯å£æœªç›‘å¬"
        
        # æ£€æŸ¥æ—¥å¿—
        echo "æ¡Œé¢æ—¥å¿—ç‰‡æ®µ:"
        tail -20 ~/desktop.log || echo "æ— æ—¥å¿—"

    - name: Start Cloudflared Tunnel
      run: |
        echo "å¯åŠ¨Cloudflaredéš§é“..."
        
        # ç®€å•å¯åŠ¨cloudflaredéš§é“
        cloudflared tunnel --url http://localhost:6080 > ~/tunnel.log 2>&1 &
        TUNNEL_PID=$!
        
        echo "ç­‰å¾…éš§é“å»ºç«‹..."
        sleep 25
        
        # æ£€æŸ¥éš§é“æ—¥å¿—
        echo "éš§é“æ—¥å¿—:"
        cat ~/tunnel.log
        
        # å°è¯•æå–URL
        echo "å°è¯•æå–è®¿é—®URL..."
        if grep -q "trycloudflare.com" ~/tunnel.log; then
          TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' ~/tunnel.log | head -1)
          echo "éš§é“å·²å»ºç«‹ï¼"
          echo "è®¿é—®åœ°å€: $TUNNEL_URL"
          echo "VNCå¯†ç : asdf1234"
          echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "::notice title=è®¿é—®ä¿¡æ¯::æ¡Œé¢å·²å¯åŠ¨ï¼è®¿é—®åœ°å€: $TUNNEL_URL VNCå¯†ç : asdf1234"
        else
          echo "ç­‰å¾…éš§é“URLç”Ÿæˆ..."
          # å†æ¬¡ç­‰å¾…å¹¶æ£€æŸ¥
          sleep 10
          if grep -q "trycloudflare.com" ~/tunnel.log; then
            TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' ~/tunnel.log | head -1)
            echo "éš§é“URL: $TUNNEL_URL"
            echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
          else
            echo "æœªæ‰¾åˆ°éš§é“URLï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            echo "å¯èƒ½çš„åŽŸå› :"
            echo "1. æ¡Œé¢çŽ¯å¢ƒæœªæ­£ç¡®å¯åŠ¨"
            echo "2. Cloudflaredè¿žæŽ¥é—®é¢˜"
            echo "3. ç«¯å£æœªç›‘å¬"
          fi
        fi

    - name: Keep alive and display info
      run: |
        echo "=========================================="
        echo "     Ubuntu Desktop çŽ¯å¢ƒä¿¡æ¯"
        echo "=========================================="
        echo ""
        
        if [ -n "${{ env.NOVNC_URL }}" ]; then
          echo "âœ… è®¿é—®åœ°å€: ${{ env.NOVNC_URL }}"
        else
          echo "âš ï¸  æœªèƒ½èŽ·å–éš§é“URLï¼Œå°è¯•æ‰‹åŠ¨æ£€æŸ¥:"
          echo "   1. æŸ¥çœ‹éš§é“æ—¥å¿—: cat ~/tunnel.log"
          echo "   2. æŸ¥çœ‹æ¡Œé¢æ—¥å¿—: cat ~/desktop.log"
          echo "   3. æ£€æŸ¥æœ¬åœ°ç«¯å£:"
          echo "      - noVNC: http://localhost:6080"
          echo "      - VNC: localhost:5900"
        fi
        
        echo ""
        echo "ðŸ”‘ VNCå¯†ç : asdf1234"
        echo ""
        echo "ðŸ“Š å½“å‰è¿›ç¨‹çŠ¶æ€:"
        ps aux | grep -E '(Xvfb|x11vnc|novnc|cloudflared)' | grep -v grep || echo "æ— ç›¸å…³è¿›ç¨‹"
        echo ""
        echo "ðŸ”Œ ç«¯å£ç›‘å¬çŠ¶æ€:"
        netstat -tlnp | grep -E '(5900|6080)' || echo "æ— ç«¯å£ç›‘å¬"
        echo ""
        echo "=========================================="
        echo "å·¥ä½œæµå°†ä¿æŒè¿è¡Œï¼Œæœ€é•¿6å°æ—¶"
        echo "æŒ‰Ctrl+Cæˆ–å–æ¶ˆå·¥ä½œæµä»¥åœæ­¢"
        echo "=========================================="
        
        # ä¿æŒè¿è¡Œï¼ˆæ˜¾ç¤ºå®žæ—¶æ—¥å¿—ï¼‰
        echo "æ˜¾ç¤ºå®žæ—¶éš§é“æ—¥å¿—:"
        tail -f ~/tunnel.log &
        TAIL_PID=$!
        
        # è¶…æ—¶è®¾ç½®ï¼ˆ6å°æ—¶ï¼‰
        timeout 6h bash -c '
        echo "å·¥ä½œæµè¿è¡Œä¸­..."
        while true; do
          sleep 60
          echo "$(date): å·¥ä½œæµä»åœ¨è¿è¡Œ"
        done
        '
        
        # æ¸…ç†
        kill $TAIL_PID 2>/dev/null || true
