name: Linux Desktop
on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y xfce4 x11vnc novnc net-tools
        
    - name: Start desktop with plain password
      run: |
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„è¿›ç¨‹
        pkill -f "Xvfb" 2>/dev/null || true
        pkill -f "x11vnc" 2>/dev/null || true
        
        # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º
        Xvfb :99 -screen 0 1024x768x24 -ac &
        export DISPLAY=:99
        sleep 3
        
        # å¯åŠ¨XFCE
        startxfce4 &
        sleep 8
        
        # å¯åŠ¨VNCï¼ˆä½¿ç”¨æ˜æ–‡å¯†ç ï¼Œç¡®ä¿æ­£ç¡®ï¼‰
        x11vnc -display :99 -forever -shared -rfbport 5900 -passwd asdf1234 -bg -noxdamage
        
        # ç­‰å¾…VNCå¯åŠ¨
        sleep 3
        
        # å¯åŠ¨noVNC
        /usr/share/novnc/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
        
        echo "æœåŠ¡å¯åŠ¨å®Œæˆï¼Œç­‰å¾…15ç§’..."
        sleep 15
        
        # éªŒè¯æœåŠ¡
        echo "æ£€æŸ¥è¿›ç¨‹:"
        ps aux | grep -E "(x11vnc|novnc|Xvfb)" | grep -v grep
        
        echo "æ£€æŸ¥ç«¯å£:"
        netstat -tlnp 2>/dev/null | grep -E "(5900|6080)"
        
    - name: Setup cloudflared tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        
        # å¯åŠ¨éš§é“
        ./cloudflared-linux-amd64 tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        sleep 35
        
        echo "éš§é“æ—¥å¿—:"
        grep -o 'https://[^ ]*\.trycloudflare\.com' tunnel.log || echo "URLæœªæ‰¾åˆ°ï¼ŒæŸ¥çœ‹å®Œæ•´æ—¥å¿—"
        
    - name: Display info and keep running
      run: |
        echo "========================================"
        echo "         ğŸ–¥ï¸  æ¡Œé¢è®¿é—®ä¿¡æ¯"
        echo "========================================"
        echo ""
        echo "ğŸ”‘ å¯†ç : asdf1234"
        echo ""
        echo "â³ ç­‰å¾…éš§é“URLç”Ÿæˆ..."
        echo ""
        
        # æ˜¾ç¤ºå®æ—¶éš§é“æ—¥å¿—
        timeout 355m tail -f tunnel.log
