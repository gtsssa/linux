name: Linux Desktop
on: 
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install lightweight desktop
      run: |
        # å®‰è£…è½»é‡çº§æ¡Œé¢ç¯å¢ƒ
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          fluxbox \
          x11vnc \
          novnc \
          websockify \
          wget \
          curl \
          python3 \
          python3-pip \
          net-tools
        
        # å®‰è£…ä¸­æ–‡å­—ä½“æ”¯æŒï¼ˆå¯é€‰ï¼‰
        sudo apt-get install -y fonts-wqy-zenhei
        
        echo "å®‰è£…å®Œæˆ"

    - name: Setup VNC password
      run: |
        mkdir -p ~/.vnc
        
        # ä½¿ç”¨x11vncè‡ªå¸¦çš„å¯†ç è®¾ç½®æ–¹æ³•
        cat > ~/set_vnc_passwd.py << 'EOF'
#!/usr/bin/env python3
import sys
import os

def create_vnc_passwd(password):
    """åˆ›å»ºx11vncå…¼å®¹çš„å¯†ç æ–‡ä»¶"""
    import subprocess
    import tempfile
    
    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥å­˜å‚¨å¯†ç 
    with tempfile.NamedTemporaryFile(mode='w', delete=False) as f:
        f.write(password)
        temp_file = f.name
    
    try:
        # ä½¿ç”¨x11vncçš„-storepasswdå‘½ä»¤
        cmd = ['x11vnc', '-storepasswd', password, os.path.expanduser('~/.vnc/passwd')]
        process = subprocess.Popen(cmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        # è¾“å…¥ç¡®è®¤
        output, error = process.communicate(input=b'\n\n')
        
        if process.returncode == 0:
            print("VNCå¯†ç è®¾ç½®æˆåŠŸ")
            return True
        else:
            print(f"è®¾ç½®å¤±è´¥: {error.decode()}")
            return False
    finally:
        if os.path.exists(temp_file):
            os.unlink(temp_file)

if __name__ == "__main__":
    create_vnc_passwd("asdf1234")
EOF
        
        python3 ~/set_vnc_passwd.py
        
        # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥åˆ›å»ºå¯†ç æ–‡ä»¶
        if [ ! -f ~/.vnc/passwd ]; then
          echo "ä½¿ç”¨å¤‡ç”¨æ–¹æ³•åˆ›å»ºå¯†ç æ–‡ä»¶"
          x11vnc -storepasswd asdf1234 ~/.vnc/passwd <<EOF
y
EOF
        fi
        
        chmod 600 ~/.vnc/passwd

    - name: Start virtual desktop
      run: |
        # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º
        Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &
        export DISPLAY=:99
        
        # ç­‰å¾…Xvfbå¯åŠ¨
        sleep 3
        
        # å¯åŠ¨è½»é‡çº§çª—å£ç®¡ç†å™¨
        fluxbox &
        sleep 2
        
        # å¯åŠ¨xtermç»ˆç«¯ï¼ˆå¯é€‰ï¼‰
        xterm -geometry 80x24+10+10 -bg black -fg white &
        
        # å¯åŠ¨VNCæœåŠ¡å™¨
        x11vnc -display :99 -forever -shared -rfbport 5900 -passwd asdf1234 -bg -noxdamage
        
        # å¯åŠ¨noVNC
        websockify -D --web=/usr/share/novnc/ 6080 localhost:5900
        
        echo "æ¡Œé¢ç¯å¢ƒå¯åŠ¨å®Œæˆ"

    - name: Download Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        ./cloudflared-linux-amd64 --version

    - name: Start services with background jobs
      run: |
        # ä¿å­˜PIDä»¥ä¾¿åç»­ç®¡ç†
        echo "å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º..."
        Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset > /dev/null 2>&1 &
        echo $! > xvfb.pid
        
        sleep 3
        export DISPLAY=:99
        
        echo "å¯åŠ¨Fluxbox..."
        fluxbox > /dev/null 2>&1 &
        echo $! > fluxbox.pid
        
        sleep 2
        
        echo "å¯åŠ¨VNC..."
        x11vnc -display :99 -forever -shared -rfbport 5900 -passwd asdf1234 -bg -noxdamage > /dev/null 2>&1
        echo $! > vnc.pid
        
        echo "å¯åŠ¨noVNC..."
        websockify -D --web=/usr/share/novnc/ 6080 localhost:5900 > /dev/null 2>&1 &
        echo $! > novnc.pid
        
        echo "å¯åŠ¨Cloudflaredéš§é“..."
        ./cloudflared-linux-amd64 tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        echo $! > cloudflared.pid
        
        sleep 10
        
        echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
        echo "Xvfb PID: $(cat xvfb.pid 2>/dev/null || echo 'æœªè¿è¡Œ')"
        echo "Fluxbox PID: $(cat fluxbox.pid 2>/dev/null || echo 'æœªè¿è¡Œ')"
        echo "VNC PID: $(cat vnc.pid 2>/dev/null || echo 'æœªè¿è¡Œ')"
        echo "noVNC PID: $(cat novnc.pid 2>/dev/null || echo 'æœªè¿è¡Œ')"
        echo "Cloudflared PID: $(cat cloudflared.pid 2>/dev/null || echo 'æœªè¿è¡Œ')"
        
        echo -e "\nç«¯å£ç›‘å¬çŠ¶æ€:"
        netstat -tlnp 2>/dev/null | grep -E '(5900|6080)' || echo "ç«¯å£æœªç›‘å¬"
        
        echo -e "\nCloudflaredéš§é“ä¿¡æ¯:"
        if [ -f tunnel.log ]; then
          if grep -q "trycloudflare.com" tunnel.log; then
            TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' tunnel.log | head -1)
            echo "âœ… éš§é“URL: $TUNNEL_URL"
            echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
            echo "::notice title=è®¿é—®ä¿¡æ¯::æ¡Œé¢å·²å¯åŠ¨ï¼è®¿é—®åœ°å€: $TUNNEL_URL å¯†ç : asdf1234"
          else
            echo "æ­£åœ¨ç­‰å¾…éš§é“å»ºç«‹..."
            # æ˜¾ç¤ºéƒ¨åˆ†æ—¥å¿—
            tail -5 tunnel.log
          fi
        fi

    - name: Display connection info
      run: |
        echo "=========================================="
        echo "        Linux Desktop ç¯å¢ƒ"
        echo "=========================================="
        echo ""
        
        # å°è¯•è·å–URL
        if [ -f tunnel.log ]; then
          echo "æ£€æŸ¥éš§é“çŠ¶æ€..."
          for i in {1..5}; do
            if grep -q "trycloudflare.com" tunnel.log; then
              TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' tunnel.log | head -1)
              echo "âœ… éš§é“å·²å»ºç«‹ï¼"
              echo "è®¿é—®åœ°å€: $TUNNEL_URL"
              echo "å¯†ç : asdf1234"
              echo ""
              echo "å¦‚æœæ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶URLè®¿é—®"
              break
            fi
            echo "ç­‰å¾…éš§é“å»ºç«‹ ($i/5)..."
            sleep 5
          done
        fi
        
        echo ""
        echo "ğŸ“Š æœ¬åœ°è®¿é—®ä¿¡æ¯:"
        echo "- VNC åœ°å€: localhost:5900"
        echo "- noVNCåœ°å€: http://localhost:6080"
        echo "- å¯†ç : asdf1234"
        echo ""
        echo "ğŸ”§ æ•…éšœæ’æŸ¥:"
        echo "1. æŸ¥çœ‹éš§é“æ—¥å¿—: tail -f tunnel.log"
        echo "2. æ£€æŸ¥è¿›ç¨‹: ps aux | grep -E '(Xvfb|fluxbox|x11vnc|websockify|cloudflared)'"
        echo "3. æ£€æŸ¥ç«¯å£: netstat -tlnp"
        echo ""
        echo "=========================================="
        echo "å·¥ä½œæµå°†åœ¨åå°è¿è¡Œ"
        echo "=========================================="

    - name: Keep workflow running
      run: |
        # æ˜¾ç¤ºå®æ—¶æ—¥å¿—
        echo "æ˜¾ç¤ºå®æ—¶éš§é“æ—¥å¿— (Ctrl+C åœæ­¢):"
        echo ""
        
        # ç›‘æ§éš§é“æ—¥å¿—
        tail -f tunnel.log &
        TAIL_PID=$!
        
        # ç›‘æ§è¿›ç¨‹çŠ¶æ€
        (
          while true; do
            echo ""
            echo "[$(date +'%H:%M:%S')] è¿›ç¨‹çŠ¶æ€:"
            ps aux | grep -E '(Xvfb|fluxbox|x11vnc|websockify|cloudflared)' | grep -v grep | awk '{print $11, $12}' | head -5
            echo "ç«¯å£ç›‘å¬:"
            netstat -tln 2>/dev/null | grep -E '(5900|6080)' || echo "  æ— "
            sleep 30
          done
        ) &
        MONITOR_PID=$!
        
        # è®¾ç½®è¶…æ—¶ï¼ˆæœ€é•¿6å°æ—¶ï¼‰
        timeout 6h bash -c '
        echo "å·¥ä½œæµä¿æŒè¿è¡Œä¸­..."
        echo "è¦åœæ­¢å·¥ä½œæµï¼Œè¯·ç‚¹å‡»GitHub Actionsä¸­çš„"Cancel workflow""
        echo ""
        
        # ç®€å•çš„ä¿æŒè¿è¡Œå¾ªç¯
        while true; do
          sleep 300
          echo "[$(date +"%Y-%m-%d %H:%M:%S")] å·¥ä½œæµä»åœ¨è¿è¡Œ..."
        done
        '
        
        # æ¸…ç†
        kill $TAIL_PID 2>/dev/null || true
        kill $MONITOR_PID 2>/dev/null || true
        
    - name: Cleanup (always run)
      if: always()
      run: |
        echo "æ¸…ç†è¿›ç¨‹..."
        for pid_file in xvfb.pid fluxbox.pid vnc.pid novnc.pid cloudflared.pid; do
          if [ -f "$pid_file" ]; then
            pid=$(cat "$pid_file")
            kill $pid 2>/dev/null || true
            echo "å·²ç»ˆæ­¢è¿›ç¨‹ $pid ($pid_file)"
          fi
        done
        
        # ç»ˆæ­¢ç›¸å…³è¿›ç¨‹
        pkill -f "Xvfb\|fluxbox\|x11vnc\|websockify\|cloudflared" 2>/dev/null || true
        echo "æ¸…ç†å®Œæˆ"
