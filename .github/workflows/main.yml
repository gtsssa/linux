name: Linux Desktop
on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup desktop
      run: |
        # 安装桌面和终端
        sudo apt update
        sudo apt install -y \
          xfce4 \
          x11vnc \
          novnc \
          xterm \
          lxterminal \
          firefox
        
        # 启动
        Xvfb :99 -screen 0 1024x768x24 &
        export DISPLAY=:99
        sleep 3
        
        startxfce4 &
        sleep 10
        
        x11vnc -display :99 -forever -passwd asdf1234 -bg
        
        /usr/share/novnc/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
        
        echo "桌面已启动，终端已安装"
        
    - name: Create tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        ./cloudflared-linux-amd64 tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        
    - name: Wait and show URL
      run: |
        sleep 30
        echo "终端快捷键: Ctrl+Alt+T"
        echo "密码: asdf1234"
        timeout 350m tail -f tunnel.log
