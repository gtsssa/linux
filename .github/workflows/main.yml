name: Linux Desktop
on: 
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Ubuntu Desktop with NoVNC
      run: |
        # å®‰è£…å¿…è¦çš„ä¾èµ–
        sudo apt-get update
        sudo apt-get install -y \
          xfce4 \
          xfce4-goodies \
          x11vnc \
          novnc \
          websockify \
          firefox \
          git \
          curl \
          wget \
          gnome-terminal \
          net-tools \
          dbus-x11
        
        # åˆ›å»ºVNCå¯†ç æ–‡ä»¶ - ä½¿ç”¨æ­£ç¡®çš„éäº¤äº’æ–¹æ³•
        mkdir -p ~/.vnc
        
        # æ–¹æ³•1ï¼šä½¿ç”¨echoç®¡é“è‡ªåŠ¨ç¡®è®¤ï¼ˆæœ€å¯é ï¼‰
        echo "asdf1234" > /tmp/vncpwd
        x11vnc -storepasswd asdf1234 ~/.vnc/passwd < <(echo -e "y\ny") 2>/dev/null || true
        
        # æ–¹æ³•2ï¼šå¤‡ç”¨æ–¹æ¡ˆï¼Œç›´æ¥åˆ›å»ºæ­£ç¡®çš„å¯†ç æ–‡ä»¶
        if [ ! -f ~/.vnc/passwd ] || [ ! -s ~/.vnc/passwd ]; then
          echo "ä½¿ç”¨å¤‡ç”¨æ–¹æ³•åˆ›å»ºå¯†ç æ–‡ä»¶..."
          # x11vncå¯†ç æ ¼å¼ï¼šæ¯ä¸ªå­—ç¬¦åè·Ÿç©ºå­—èŠ‚
          python3 << 'EOF'
import os
password = "asdf1234"
passwd_bytes = b''
for char in password:
    passwd_bytes += char.encode('utf-8')
    passwd_bytes += b'\x00'
# ç¡®ä¿é•¿åº¦æ˜¯8å­—èŠ‚
while len(passwd_bytes) < 8:
    passwd_bytes += b'\x00'
passwd_bytes = passwd_bytes[:8]

with open(os.path.expanduser('~/.vnc/passwd'), 'wb') as f:
    f.write(passwd_bytes)
print(f"å¯†ç æ–‡ä»¶å·²åˆ›å»ºï¼Œå¤§å°: {len(passwd_bytes)} å­—èŠ‚")
EOF
        fi
        
        chmod 600 ~/.vnc/passwd
        
        # éªŒè¯å¯†ç æ–‡ä»¶
        echo "å¯†ç æ–‡ä»¶ä¿¡æ¯:"
        ls -la ~/.vnc/passwd
        echo "æ–‡ä»¶å¤§å°: $(wc -c < ~/.vnc/passwd) å­—èŠ‚"
        echo "æ–‡ä»¶å†…å®¹ï¼ˆåå…­è¿›åˆ¶ï¼‰:"
        xxd ~/.vnc/passwd
        
        # é…ç½®ç¯å¢ƒå˜é‡
        echo "export DISPLAY=:1" >> ~/.bashrc
        source ~/.bashrc
        
        # è®¾ç½®è‡ªåŠ¨å¯åŠ¨è„šæœ¬ï¼ˆä½¿ç”¨-passwdå‚æ•°è€Œé-passwdfileï¼‰
        cat > ~/start_desktop.sh << 'EOF'
#!/bin/bash
# æ¸…ç†æ—§è¿›ç¨‹
pkill -f "Xvfb" 2>/dev/null || true
pkill -f "xfce" 2>/dev/null || true
pkill -f "x11vnc" 2>/dev/null || true
pkill -f "websockify" 2>/dev/null || true

# å¯åŠ¨Xvfbè™šæ‹Ÿæ˜¾ç¤º
Xvfb :1 -screen 0 1024x768x24 -ac +extension GLX +render -noreset >/dev/null 2>&1 &
sleep 3

export DISPLAY=:1

# å¯åŠ¨XFCEï¼ˆåå°è¿è¡Œï¼‰
startxfce4 >/dev/null 2>&1 &
sleep 5

# å¯åŠ¨VNC - ä½¿ç”¨-passwdå‚æ•°
echo "å¯åŠ¨VNCæœåŠ¡å™¨..."
if [ -f ~/.vnc/passwd ] && [ -s ~/.vnc/passwd ]; then
    echo "ä½¿ç”¨å¯†ç æ–‡ä»¶"
    x11vnc -display :1 -forever -shared -rfbport 5900 -passwdfile ~/.vnc/passwd -bg -noxdamage >/dev/null 2>&1
else
    echo "ä½¿ç”¨æ˜æ–‡å¯†ç "
    x11vnc -display :1 -forever -shared -rfbport 5900 -passwd asdf1234 -bg -noxdamage >/dev/null 2>&1
fi

# ç­‰å¾…VNCå¯åŠ¨
sleep 2

# å¯åŠ¨noVNC
echo "å¯åŠ¨noVNC..."
websockify --daemon --web /usr/share/novnc/ 6080 localhost:5900

echo "æœåŠ¡å·²å¯åŠ¨:"
echo "- VNCç«¯å£: 5900"
echo "- noVNCç«¯å£: 6080"
echo "- å¯†ç : asdf1234"

# ä¿æŒè„šæœ¬è¿è¡Œ
while true; do
    sleep 60
done
EOF
        
        chmod +x ~/start_desktop.sh

    - name: Start desktop services
      run: |
        # å¯åŠ¨æ¡Œé¢æœåŠ¡
        bash ~/start_desktop.sh > ~/desktop.log 2>&1 &
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "ç­‰å¾…æ¡Œé¢æœåŠ¡å¯åŠ¨..."
        for i in {1..15}; do
            if netstat -tln 2>/dev/null | grep -q ":6080"; then
                echo "âœ“ noVNCå·²å¯åŠ¨ (ç«¯å£6080)"
                break
            fi
            echo "ç­‰å¾…ä¸­... ($i/15)"
            sleep 2
        done
        
        echo "æ£€æŸ¥VNCç«¯å£..."
        if netstat -tln 2>/dev/null | grep -q ":5900"; then
            echo "âœ“ VNCå·²å¯åŠ¨ (ç«¯å£5900)"
        else
            echo "âœ— VNCç«¯å£æœªç›‘å¬"
        fi
        
        echo "æ¡Œé¢æœåŠ¡æ—¥å¿—:"
        tail -20 ~/desktop.log

    - name: Download and setup Cloudflared
      run: |
        # ä¸‹è½½cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared
        ./cloudflared --version

    - name: Start Cloudflared tunnel
      run: |
        # å¯åŠ¨éš§é“
        echo "å¯åŠ¨Cloudflaredéš§é“..."
        ./cloudflared tunnel --url http://localhost:6080 > ~/tunnel.log 2>&1 &
        
        # ç­‰å¾…éš§é“å»ºç«‹
        sleep 25
        
        echo "éš§é“æ—¥å¿—:"
        cat ~/tunnel.log
        
        # æå–URL
        if grep -q "trycloudflare.com" ~/tunnel.log; then
            TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' ~/tunnel.log | head -1)
            echo "âœ“ éš§é“å·²å»ºç«‹!"
            echo "è®¿é—®åœ°å€: $TUNNEL_URL"
            echo "å¯†ç : asdf1234"
            echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
            echo "::notice title=è®¿é—®ä¿¡æ¯::æ¡Œé¢å·²å¯åŠ¨ï¼è®¿é—®åœ°å€: $TUNNEL_URL å¯†ç : asdf1234"
        else
            echo "æ­£åœ¨ç­‰å¾…éš§é“URL..."
            # å†æ¬¡æ£€æŸ¥
            sleep 10
            if grep -q "trycloudflare.com" ~/tunnel.log; then
                TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' ~/tunnel.log | head -1)
                echo "æ‰¾åˆ°URL: $TUNNEL_URL"
                echo "NOVNC_URL=$TUNNEL_URL" >> $GITHUB_ENV
            else
                echo "æœªèƒ½è·å–éš§é“URLï¼Œè¯·æ£€æŸ¥éš§é“æ—¥å¿—"
                echo "å¤‡ç”¨è®¿é—®æ–¹å¼:"
                echo "1. ä½¿ç”¨curl: curl http://localhost:6080"
                echo "2. ç›´æ¥VNCè¿æ¥: localhost:5900"
            fi
        fi

    - name: Monitor and keep alive
      run: |
        echo "========================================"
        echo "      Ubuntu Desktop è¿è¡Œä¸­"
        echo "========================================"
        
        if [ -n "${{ env.NOVNC_URL }}" ]; then
            echo "ğŸŒ åœ¨çº¿è®¿é—®: ${{ env.NOVNC_URL }}"
        else
            echo "ğŸŒ éš§é“URL: æ­£åœ¨ç”Ÿæˆ..."
        fi
        echo "ğŸ”‘ å¯†ç : asdf1234"
        echo ""
        echo "ğŸ“Š æœ¬åœ°ä¿¡æ¯:"
        echo "- VNC: localhost:5900"
        echo "- noVNC: http://localhost:6080"
        echo ""
        echo "ğŸ” æœåŠ¡çŠ¶æ€:"
        
        # ç›‘æ§å¾ªç¯
        for i in {1..360}; do  # 6å°æ—¶
            echo ""
            echo "[$(date '+%H:%M:%S')] çŠ¶æ€æ£€æŸ¥:"
            
            # æ£€æŸ¥è¿›ç¨‹
            echo "è¿›ç¨‹:"
            ps aux | grep -E '(Xvfb|xfce|vnc|websockify|cloudflared)' | grep -v grep | awk '{print $11, $12}' | head -5 || echo "  æ— "
            
            # æ£€æŸ¥ç«¯å£
            echo "ç«¯å£:"
            netstat -tln 2>/dev/null | grep -E '(5900|6080)' || echo "  æ— ç«¯å£ç›‘å¬"
            
            # æ£€æŸ¥éš§é“
            if [ -f ~/tunnel.log ] && tail -5 ~/tunnel.log | grep -q "trycloudflare.com"; then
                echo "éš§é“: âœ… æ­£å¸¸"
            else
                echo "éš§é“: â³ è¿æ¥ä¸­..."
            fi
            
            sleep 60
        done

    - name: Cleanup
      if: always()
      run: |
        echo "æ¸…ç†è¿›ç¨‹..."
        pkill -f "Xvfb" 2>/dev/null || true
        pkill -f "xfce" 2>/dev/null || true
        pkill -f "x11vnc" 2>/dev/null || true
        pkill -f "websockify" 2>/dev/null || true
        pkill -f "cloudflared" 2>/dev/null || true
        echo "æ¸…ç†å®Œæˆ"
