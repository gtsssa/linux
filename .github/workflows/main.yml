name: Linux Desktop
on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install and setup
      run: |
        # 安装
        sudo apt update
        sudo apt install -y xfce4 x11vnc novnc websockify
        
        # 创建密码
        mkdir -p ~/.vnc
        echo -e "y\ny" | x11vnc -storepasswd asdf1234 ~/.vnc/passwd
        
        # 启动服务
        export DISPLAY=:1
        Xvfb :1 -screen 0 1024x768x24 &
        sleep 3
        startxfce4 &
        sleep 5
        x11vnc -display :1 -forever -passwdfile ~/.vnc/passwd -bg
        websockify 6080 localhost:5900 &
        
    - name: Start tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        ./cloudflared-linux-amd64 tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        sleep 25
        grep 'trycloudflare.com' tunnel.log && echo "查看日志: tail -f tunnel.log"
        
    - name: Run
      run: |
        echo "密码: asdf1234"
        timeout 6h sleep infinity
